# 프리 패스 시스템 구현 계획 정합성 검토 결과

## 검토 일시
2026-01-XX

## 현재 구현 상태

### ✅ 이미 구현된 기반 구조

1. **데이터베이스 인프라**
   - `FaustDatabase`: Room Database 버전 1
   - `PointTransactionDao`: 포인트 거래 관리
   - `AppBlockDao`: 차단 앱 관리
   - 트랜잭션 보장 메커니즘 (`withTransaction`)

2. **포인트 시스템**
   - `PointTransaction` 엔티티
   - `TransactionType` enum에 **PURCHASE 타입이 이미 정의됨** (주석: "MVP 제외")
   - 포인트 계산: `SUM(amount)` 방식
   - 트랜잭션 기반 포인트 차감 로직

3. **앱 카테고리 시스템**
   - `AppCategoryUtils`: 앱 카테고리 유틸리티
   - `CATEGORY_SOCIAL`: SNS 앱 구분 가능
   - `CATEGORY_VIDEO`: OTT 앱 구분 가능
   - 하이브리드 방식 지원 가능 (카테고리 + 패키지명)

4. **시간 관리 인프라**
   - `TimeUtils`: 기본 시간 유틸리티
   - `WeeklyResetService`: AlarmManager 기반 스케줄링 패턴 참고 가능
   - `PreferenceManager`: EncryptedSharedPreferences 기반 설정 관리

5. **서비스 아키텍처**
   - `AppBlockingService`: 앱 차단 로직 (수정 필요)
   - `PointMiningService`: 포인트 채굴 서비스
   - `PenaltyService`: 페널티 적용 로직 (구매 시 포인트 차감 참고)

### ❌ 아직 구현되지 않은 항목

1. **데이터 모델**
   - `FreePassItem` 엔티티
   - `DailyUsageRecord` 엔티티
   - `AppGroup` 엔티티
   - 관련 DAO들

2. **도메인 서비스**
   - `FreePassService`
   - `DailyResetService`
   - `AppGroupService`
   - `ActivePassService`

3. **프레젠테이션 레이어**
   - `ShopFragment`
   - `ShopViewModel`
   - `SettingsFragment`

4. **유틸리티 확장**
   - `TimeUtils` 사용자 지정 시간 관련 메서드
   - `PreferenceManager` 사용자 지정 리셋 시간 저장/조회

## 계획과의 정합성 분석

### ✅ 계획과 일치하는 부분

1. **아키텍처 패턴**
   - 계획의 레이어 구조가 기존 아키텍처와 일치
   - MVVM 패턴 사용 (기존 MainViewModel 패턴 참고)
   - Service-Oriented Architecture 유지

2. **데이터 관리 방식**
   - 트랜잭션 보장 방식 일치 (`withTransaction`)
   - Flow 기반 반응형 데이터 (기존 패턴과 일치)
   - PreferenceManager 사용 방식 일치

3. **스케줄링 패턴**
   - AlarmManager 사용 (WeeklyResetService 패턴 참고 가능)
   - BroadcastReceiver 패턴 일치

4. **앱 그룹 관리**
   - AppCategoryUtils 활용 가능
   - 하이브리드 방식 (카테고리 + 패키지명) 지원 가능

### ⚠️ 계획 수정이 필요한 부분

1. **TransactionType.PURCHASE 활용**
   - 계획: PURCHASE 타입 사용
   - 현실: 이미 정의되어 있음 (주석: "MVP 제외")
   - **조치**: PURCHASE 타입을 활성화하여 사용

2. **데이터베이스 버전**
   - 계획: 버전 1 → 2 업그레이드
   - 현실: 현재 버전 1
   - **조치**: Migration 스크립트 작성 필요
   - **주의**: `fallbackToDestructiveMigration()` 사용 중이므로 신중한 Migration 필요

3. **일일 초기화 시간**
   - 계획: 사용자 지정 시간 (기본값 00:00)
   - 현실: WeeklyResetService는 고정 시간 (월요일 00:00)
   - **조치**: DailyResetService는 사용자 지정 시간 지원하도록 구현

4. **앱 그룹 초기화**
   - 계획: 앱 설치 시 기본 SNS/OTT 앱 그룹 자동 설정
   - 현실: AppCategoryUtils는 런타임에 카테고리 조회
   - **조치**: AppGroupService에서 초기 데이터 설정 로직 추가

### 🔍 잠재적 문제점 및 해결 방안

1. **데이터베이스 Migration**
   - **문제**: `fallbackToDestructiveMigration()` 사용 중
   - **해결**: Migration 스크립트를 정확히 작성하거나, 사용자 데이터 백업 고려

2. **앱 그룹 초기화 타이밍**
   - **문제**: 언제 기본 앱 그룹을 설정할지 명확하지 않음
   - **해결**: 
     - 앱 첫 실행 시 초기화
     - 또는 AppGroupService 초기화 시 자동 설정

3. **사용자 지정 시간 변경 시 기존 데이터**
   - **문제**: 사용자가 리셋 시간을 변경하면 기존 DailyUsageRecord의 날짜 계산이 달라질 수 있음
   - **해결**: 
     - 리셋 시간 변경 시 기존 기록은 유지
     - 새로운 날짜 계산은 변경된 시간 기준으로 적용

4. **타이머 관리**
   - **문제**: Foreground Service vs WorkManager 선택
   - **해결**: 
     - ActivePassService에서 타이머 관리
     - 앱이 종료되어도 타이머가 동작해야 하므로 WorkManager 고려

5. **프리 패스 활성화 시 AppBlockingService 수정**
   - **문제**: 기존 차단 로직과의 통합
   - **해결**: 
     - `handleAppLaunch()`에서 프리 패스 체크를 Grace Period 체크 이후, 오버레이 표시 전에 수행
     - 기존 로직 보존 (Zero-deletion Policy 준수)

## 권장 사항

### 1. 구현 우선순위 조정

현재 계획의 구현 순서는 적절하지만, 다음 순서를 권장:

1. **TimeUtils 확장** (다른 서비스들이 의존)
2. **PreferenceManager 확장** (설정 저장)
3. **데이터 모델 및 DAO** (기반 구조)
4. **데이터베이스 업그레이드** (Migration)
5. **AppGroupService** (다른 서비스들이 의존)
6. **FreePassService** (핵심 비즈니스 로직)
7. **DailyResetService** (일일 초기화)
8. **ActivePassService** (타이머 관리)
9. **AppBlockingService 수정** (통합)
10. **프레젠테이션 레이어** (UI)

### 2. Migration 전략

- **옵션 1**: 정확한 Migration 스크립트 작성
  - 기존 데이터 보존
  - 복잡도 높음

- **옵션 2**: 사용자 데이터 백업 후 Migration
  - 안전성 높음
  - 사용자 경험 고려 필요

### 3. 테스트 전략

- **단위 테스트**: 각 서비스별 로직 테스트
- **통합 테스트**: 프리 패스 구매 → 사용 → 차단 해제 플로우
- **시간 관련 테스트**: 사용자 지정 시간 변경 시나리오

## 결론

### ✅ 계획의 타당성

계획은 기존 아키텍처와 잘 맞으며, 구현 가능한 구조입니다.

### ✅ 기존 코드와의 호환성

- 기존 아키텍처 패턴 준수
- 기존 서비스와의 통합 가능
- Zero-deletion Policy 준수 가능

### ⚠️ 주의 사항

1. **데이터베이스 Migration**: 신중한 접근 필요
2. **타이머 관리**: 앱 종료 후에도 동작해야 함
3. **사용자 지정 시간 변경**: 기존 데이터와의 호환성 고려

### 📋 다음 단계

1. 계획 검토 완료 ✅
2. 구현 시작 준비 완료 ✅
3. 구현 시작 대기 중 ⏳
